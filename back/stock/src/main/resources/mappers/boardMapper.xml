<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.dk.project.board.model.dao.BoardMapper">
  
  <select id="selectBoard"
  		  parameterType="string"
  		  resultType="com.dk.project.board.model.dto.BoardDTO">
  
  		
  		SELECT
  				B.BOARD_NO boardNo,
  				B.TITLE title,
  				B.CONTENT content,
  				B.CREATE_DATE createDate,
				B.VIEW_COUNT viewCount,
				B.LIKE_COUNT likeCount,
  				U.NICKNAME nickName
  				
  		FROM
  				TB_BOARD B
  		JOIN
  				TB_USER U ON B.USER_NO = U.USER_NO
  				
  		<where>
  			<if test="category != null and category != 'all'">
  				B.CATEGORY = #{category}
  			</if>
  		</where>
  			
  	ORDER BY
				B.BOARD_NO DESC		
  
  
  </select>
  
  <insert id="insertWrite"	
  		  parameterType="com.dk.project.board.model.dto.BoardWriteDTO">
  		
  		INSERT INTO TB_BOARD (
			
			USER_NO,
			CATEGORY,
			TITLE,
			CONTENT
			
		)
  		VALUES (
			
			#{userNo},
			#{category},
			#{title},
			#{content}	
			
		)
  
  </insert>
  
  
  <select id="selectDetails"
  		  parameterType="Long"
  		  resultType="com.dk.project.board.model.dto.BoardDTO">
  
  			
  			SELECT
  					U.USER_NO userNo,
  					U.NICKNAME nickName,
  					B.BOARD_NO boardNo,
  					B.VIEW_COUNT viewCount,
   					B.LIKE_COUNT likeCount,
   					B.CREATE_DATE createDate,
   					B.CONTENT content,
   					B.TITLE title,
   					B.CATEGORY category
   			FROM
   					TB_USER U
   			JOIN
   					TB_BOARD B ON U.USER_NO = B.USER_NO
   			WHERE
   					BOARD_NO = #{boardNo}
   			
  
  </select>
  
  <update id="increaseViewCount"
  		  parameterType="Long">
  
  			UPDATE 
  					TB_BOARD
  			SET
  					VIEW_COUNT = VIEW_COUNT+1
  			WHERE
  					BOARD_NO = #{boardNo}
  
  </update>
 
  <update  id="decreaseLikeCount"
  		  parameterType="Long">
  		  
  		  	UPDATE
  		  			TB_BOARD
  		  	SET
  		  			LIKE_COUNT = LIKE_COUNT-1
  		  	WHERE
  		  		
  		  			BOARD_NO = #{boardNo}
  		  			
  </update >
  
  <update id="increaseLikeCount"
  		  parameterType="Long">
  		
			UPDATE
					TB_BOARD
			SET
					LIKE_COUNT = LIKE_COUNT+1
			WHERE
					BOARD_NO = #{boardNo}
  
  </update>
  
  <select id="seletLikeCount"
  		  resultType="com.dk.project.board.model.dto.LikeResponseDTO">
  
		  			
			  SELECT
			    	B.LIKE_COUNT likeCount,
			    CASE
			        WHEN EXISTS (
			            SELECT 1
			            FROM TB_BOARD_LIKE Bl
			            WHERE Bl.BOARD_NO = B.BOARD_NO
			              AND Bl.USER_NO = #{userNo}
			        )
			        THEN 1
			        ELSE 0
			    	END AS liked
			FROM 
					TB_BOARD B
			WHERE 
					B.BOARD_NO = #{boardNo}
  
  </select>
  
  
  
  
  <update id="updateDetails"
  		  parameterType="com.dk.project.board.model.dto.BoardDTO">
  
  			UPDATE
  					TB_BOARD
  			   SET
  					CATEGORY= #{category},
  					CONTENT = #{content},
  					TITLE = #{title}
  			WHERE
  					BOARD_NO = #{boardNo}
  
  </update>
  
  
  
  <delete id ="deleteDetails"
  		  parameterType="Long">
  
  			DELETE
  			FROM
  					TB_BOARD
  			WHERE
  					BOARD_NO = #{boardNo}	
  </delete>
  
  <insert id="insertComment"
  		  parameterType="com.dk.project.board.model.dto.CommentDTO">
  
  			INSERT INTO TB_COMMENT(
				
				BOARD_NO,
				USER_NO,
				NICKNAME,
				CONTENT,
				PARENT_NO
				
			)VALUES(
				
				#{boardNo},
				#{userNo},
				#{nickName},
				#{content},
				#{parentCommentNo,jdbcType=NUMERIC}
			)
  
  </insert>
  
  <select id="selectComment"
  		  resultType="com.dk.project.board.model.dto.CommentDTO">
  
  			SELECT
  					C.COMMENT_NO commentNo,
  					C.BOARD_NO boardNo,
  					U.NICKNAME nickName,
  					C.CONTENT content,
  					C.PARENT_NO parentCommentNo,
  					C.CREATE_DATE createDate
  					
  			FROM
  					TB_COMMENT C
  			JOIN
  					TB_USER U ON C.USER_NO = U.USER_NO
  			WHERE
  					BOARD_NO = #{boardNo}
  			
  </select>
  
  <update id="updateComment"
  		  parameterType="com.dk.project.board.model.dto.CommentDTO">
  
  			UPDATE
  					TB_COMMENT
  			SET
  					CONTENT = #{content}
  			WHERE
  					COMMENT_NO = #{commentNo}	
			AND
					USER_NO = #{userNo}  		
  
  </update>
  
  <delete id="deleteComment">
  		  
  		DELETE
  		FROM
  				TB_COMMENT
  		WHERE
  				COMMENT_NO = #{commentNo}
  		AND
  				USER_NO = #{userNo}			
  	
  </delete>
  
  
  </mapper>